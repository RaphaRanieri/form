<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Estat√≠sticas do Formul√°rio</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="estatistica.css">
</head>
<body>
  <h1>üìä Estat√≠sticas do Formul√°rio</h1>

  <h2>Contagem de Campos Preenchidos</h2>
  <canvas id="camposChart" width="400" height="200"></canvas>

  <h2>Distribui√ß√£o das Respostas</h2>
  <div id="perguntas-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 40px; margin-bottom: 20px;">
    </div>

  <footer>
    Atualiza automaticamente a cada 5 segundos
  </footer>

  <script>
    // Mapeamento das chaves do objeto para os t√≠tulos das perguntas
    const titulosPerguntas = {
        motivo1: 'Pergunta 1: Por que voc√™ √© desatento?',
        motivo2: 'Pergunta 2: Voc√™ se sente seguro?',
        motivo3: 'Pergunta 3: Voc√™ j√° foi alvo de golpe?'
    };

    // Cores pr√©-definidas para os gr√°ficos de pizza
    const cores = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
    ];

    let camposChart = null;
    let perguntasCharts = {}; // Objeto para armazenar refer√™ncias aos gr√°ficos de perguntas

    async function atualizar() {
      try {
        // Rota que o servidor deve responder com os dados JSON
        const res = await fetch('/estatisticas/dados');
        if (!res.ok) {
            throw new Error(`Erro ao buscar dados: ${res.statusText}`);
        }
        const dados = await res.json();
        
        renderizarGraficoCampos(dados.campos);
        renderizarGraficosPerguntas(dados.perguntas);

      } catch (error) {
        console.error('Falha ao atualizar estat√≠sticas:', error);
        // Exibir uma mensagem de erro na p√°gina pode ser √∫til
        // document.body.innerHTML = `<h1>Erro ao carregar dados. Verifique o console.</h1>`;
      }
    }
    
    // 1. Renderiza o Gr√°fico de Barras para Campos Preenchidos
    function renderizarGraficoCampos(dadosCampos) {
        if (camposChart) camposChart.destroy();
        
        const ctx1 = document.getElementById('camposChart').getContext('2d');
        camposChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: Object.keys(dadosCampos),
                datasets: [{
                    label: 'Campos preenchidos',
                    data: Object.values(dadosCampos),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        // Garantir que a escala Y mostre apenas n√∫meros inteiros
                        ticks: { stepSize: 1 } 
                    } 
                } 
            }
        });
    }

    // 2. Renderiza Gr√°ficos de Pizza (Doughnut) para as Perguntas
    function renderizarGraficosPerguntas(dadosPerguntas) {
        const container = document.getElementById('perguntas-container');
        // Limpa gr√°ficos anteriores
        container.innerHTML = '';
        Object.keys(perguntasCharts).forEach(key => perguntasCharts[key].destroy());
        perguntasCharts = {};

        Object.keys(dadosPerguntas).forEach((chavePergunta, index) => {
            const respostas = dadosPerguntas[chavePergunta];
            const labels = Object.keys(respostas);
            const data = Object.values(respostas);
            
            // Cria um novo container e canvas para cada gr√°fico
            const chartWrapper = document.createElement('div');
            chartWrapper.style.width = '300px'; 
            chartWrapper.style.height = '300px'; 
            chartWrapper.style.textAlign = 'center';
            chartWrapper.innerHTML = `<h3>${titulosPerguntas[chavePergunta] || chavePergunta}</h3><canvas id="${chavePergunta}Chart"></canvas>`;
            container.appendChild(chartWrapper);

            const ctx = document.getElementById(`${chavePergunta}Chart`).getContext('2d');
            
            // Cria o novo gr√°fico Doughnut
            perguntasCharts[chavePergunta] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: cores.slice(0, data.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Importante para o container
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: titulosPerguntas[chavePergunta] || chavePergunta,
                            padding: {
                                top: 5,
                                bottom: 10
                            }
                        }
                    }
                }
            });
        });
    }


    // Inicia a primeira atualiza√ß√£o e configura o intervalo
    atualizar();
    setInterval(atualizar, 5000); 
  </script>
</body>
</html>